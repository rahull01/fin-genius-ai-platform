<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FinGenius | Dashboard</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body{margin:0;font-family:Poppins;background:#f4f6fb}
        nav{display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#405DE6,#833AB4);color:#fff;padding:14px 30px}
        nav a{color:white;margin:0 10px;text-decoration:none;font-weight:500}
        .logo{font-size:22px;font-weight:700}
        .profile{position:relative;cursor:pointer}
        .profile img{width:36px;border-radius:50%}
        .menu{position:absolute;right:0;top:45px;background:white;color:black;border-radius:10px;width:200px;box-shadow:0 10px 30px rgba(0,0,0,.2);display:none;z-index:10}
        .menu p{margin:10px;font-size:14px}
        .menu button{width:90%;margin:10px;border:none;padding:8px;background:#ef4444;color:white;border-radius:6px;cursor:pointer}
        .container{padding:30px;max-width:1100px;margin:auto}
        .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px}
        .card{background:white;padding:25px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);text-align:center}
        .card h3{margin-bottom:10px;color:#4f46e5}
        .card h1{margin:0;font-size:28px}
        .section{margin-top:40px}
        .transactions{background:white;padding:20px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,.05)}
        .transactions ul{list-style:none;padding:0;margin:0}
        .transactions li{padding:10px 0;border-bottom:1px solid #eee;display:flex;justify-content:space-between}
        .actions{margin-top:20px}
        .actions button{padding:12px 20px;margin-right:10px;border:none;background:#4f46e5;color:white;border-radius:8px;cursor:pointer;font-weight:600}
        .toast{position:fixed;top:20px;right:20px;background:#16a34a;color:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 5px 20px rgba(0,0,0,.2);z-index:999;display:none}
    </style>
</head>
<body>

<nav>
    <div class="logo">FinGenius</div>
    <div>
        <a href="dashboard.html">Dashboard</a>
        <a href="transactions.html">Transactions</a>
        <a href="ai-advisor.html">AI Advisor</a>
        <a href="notifications.html">Notifications</a>
    </div>
    <div class="profile" onclick="toggleMenu()">
        <img src="https://i.pravatar.cc/100">
        <div id="menu" class="menu">
            <p id="name"></p>
            <p id="email"></p>
            <button onclick="logout()">Logout</button>
        </div>
    </div>
</nav>

<div id="toast" class="toast">Updated</div>

<div class="container">
    <div class="cards">
        <div class="card"><h3>Balance</h3><h1 id="balance">â‚¹0</h1></div>
        <div class="card"><h3>Income</h3><h1 id="income">â‚¹0</h1></div>
        <div class="card"><h3>Expense</h3><h1 id="expense">â‚¹0</h1></div>
    </div>

    <div class="section">
        <h2>Recent transactions</h2>
        <div class="transactions">
            <ul id="txnList"><li>Loading...</li></ul>
        </div>
    </div>

    <div class="actions">
        <button onclick="location.href='transactions.html'">View all transactions</button>
        <button onclick="getAdvice()">Get AI advice</button>
    </div>
</div>

<script>
    const API = "http://localhost:8086";
    const user = JSON.parse(localStorage.getItem("user"));
    if(!user) location.href = "auth.html";

    document.getElementById("name").innerText = user.fullName;
    document.getElementById("email").innerText = user.email;

    function toggleMenu(){
      const m = document.getElementById("menu");
      m.style.display = m.style.display === "block" ? "none" : "block";
    }
    function logout(){
      localStorage.clear();
      location.href = "auth.html";
    }
    function showToast(msg, ok=true){
      const t = document.getElementById("toast");
      t.style.background = ok ? "#16a34a" : "#ef4444";
      t.innerText = msg;
      t.style.display = "block";
      setTimeout(()=> t.style.display="none", 3000);
    }
    function formatINR(amount){
      return "â‚¹" + Number(amount || 0).toLocaleString("en-IN");
    }

    function loadAnalytics(){
      fetch(`${API}/api/analytics/user/${user.id}/summary`)
        .then(r => r.json())
        .then(data => {
          document.getElementById("balance").innerText = formatINR(data.balance);
          document.getElementById("income").innerText = formatINR(data.totalCredit);
          document.getElementById("expense").innerText = formatINR(data.totalDebit);
        });
    }

    function loadRecentTransactions(){
      fetch(`${API}/api/transactions/user/${user.id}`)
        .then(r => r.json())
        .then(data => {
          const list = document.getElementById("txnList");
          if(!Array.isArray(data) || data.length === 0){
            list.innerHTML = "<li>No transactions found</li>";
            return;
          }
          data.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
          list.innerHTML = data.slice(0,5).map(txn =>
            `<li><b>${txn.type}</b> <span>${formatINR(txn.amount)}</span></li>`
          ).join("");
        });
    }

    function getAdvice(){
      fetch(`${API}/api/ai/advice`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({userId: user.id})
      })
      .then(r => r.json())
      .then(data => showToast("ðŸ§  " + (data.message || "Advice generated")));
    }

    loadAnalytics();
    loadRecentTransactions();

    if(localStorage.getItem("refreshDashboard") === "true"){
      localStorage.removeItem("refreshDashboard");
      loadAnalytics();
      loadRecentTransactions();
      showToast("Dashboard updated");
    }
</script>

</body>
</html>
