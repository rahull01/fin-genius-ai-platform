<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FinGenius | AI Advisor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body{margin:0;font-family:Poppins;background:#f4f6fb;display:flex;flex-direction:column;height:100vh}
        nav{display:flex;justify-content:space-between;align-items:center;background:#4f46e5;color:#fff;padding:14px 30px}
        nav a{color:white;margin:0 10px;text-decoration:none;font-weight:500}
        .logo{font-size:22px;font-weight:700}
        .profile{position:relative;cursor:pointer}
        .profile img{width:36px;border-radius:50%}
        .menu{position:absolute;right:0;top:45px;background:white;color:black;border-radius:10px;width:200px;box-shadow:0 10px 30px rgba(0,0,0,.2);display:none;z-index:10}
        .menu p{margin:10px;font-size:14px}
        .menu button{width:90%;margin:10px;border:none;padding:8px;background:#ef4444;color:white;border-radius:6px;cursor:pointer}

        .chat-container{flex:1;overflow-y:auto;padding:20px;max-width:800px;margin:auto;width:100%}
        .bubble{max-width:70%;padding:12px 16px;margin:10px;border-radius:12px;line-height:1.5}
        .user{background:#e0e7ff;margin-left:0;border-bottom-left-radius:0}
        .ai{background:#fff;margin-left:auto;border-bottom-right-radius:0;box-shadow:0 5px 20px rgba(0,0,0,.05)}

        .input-bar{display:flex;padding:20px;background:#fff;border-top:1px solid #ddd}
        .input-bar textarea{flex:1;padding:12px;border:1px solid #ccc;border-radius:8px;resize:none;font-family:Poppins}
        .input-bar button{margin-left:10px;padding:12px 20px;background:#4f46e5;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer}
        .toast{position:fixed;top:20px;right:20px;background:#16a34a;color:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 5px 20px rgba(0,0,0,.2);z-index:999;display:none}
    </style>
</head>
<body>

<nav>
    <div class="logo">FinGenius</div>
    <div>
        <a href="dashboard.html">Dashboard</a>
        <a href="transactions.html">Transactions</a>
        <a href="ai-advisor.html">AI Advisor</a>
        <a href="notifications.html">Notifications</a>
    </div>
    <div class="profile" onclick="toggleMenu()">
        <img src="https://i.pravatar.cc/100">
        <div id="menu" class="menu">
            <p id="name"></p>
            <p id="email"></p>
            <button onclick="logout()">Logout</button>
        </div>
    </div>
</nav>

<div id="toast" class="toast">Advice received</div>

<div class="chat-container" id="chat"></div>

<div class="input-bar">
    <textarea id="question" placeholder="Ask something about your finances..."></textarea>
    <button onclick="getAdvice()">Send</button>
</div>

<script>
    const API = "http://localhost:8086";
    const user = JSON.parse(localStorage.getItem("user"));
    if(!user) location.href="auth.html";

    document.getElementById("name").innerText = user.fullName;
    document.getElementById("email").innerText = user.email;

    function toggleMenu(){
      const m = document.getElementById("menu");
      m.style.display = m.style.display === "block" ? "none" : "block";
    }
    function logout(){
      localStorage.clear();
      location.href = "auth.html";
    }
    function showToast(msg, ok=true){
      const t = document.getElementById("toast");
      t.style.background = ok ? "#16a34a" : "#ef4444";
      t.innerText = msg;
      t.style.display = "block";
      setTimeout(()=> t.style.display="none", 3000);
    }

    function addBubble(text, isAI){
      const div = document.createElement("div");
      div.className = "bubble " + (isAI ? "ai" : "user");
      div.innerText = text;
      document.getElementById("chat").appendChild(div);
      document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
    }

    function getAdvice(){
      const q = document.getElementById("question").value.trim();
      if(!q){ showToast("Please enter a question", false); return; }

      addBubble(q, false);
      document.getElementById("question").value = "";

      fetch(`${API}/api/ai/advice`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({userId: user.id, question: q})
      })
      .then(r => r.json())
      .then(data => {
        addBubble(data.advice || "No advice received", true);
        showToast("✅ Advice received");
      })
      .catch(()=> showToast("❌ Failed to get advice", false));
    }
</script>

</body>
</html>
